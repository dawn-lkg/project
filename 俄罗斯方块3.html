<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
        overflow: hidden;
        height: 100%;
      }
      table {
        border-collapse: collapse;
        margin: 10px auto;
        float: left;
        margin-right: 15px;
      }
      td {
        border: 1px solid #000;
        width: 25px;
        height: 25px;
      }
      .c1 {
        background-color: red;
      }
      .c2 {
        background-color: blue;
      }
      .c3 {
        background-color: orange;
      }
      .c4 {
        background-color: purple;
      }
      .c5 {
        background-color: skyblue;
      }
      .c6 {
        background-color: tomato;
      }
      .c7 {
        background-color: green;
      }
    </style>
  </head>
  <body>
    <script src="./js/jQuery.js"></script>
    <script>
      let square = {
        S: [
          [
            [0, 1, 1, 0],
            [1, 1, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 1, 0, 0],
            [0, 1, 1, 0],
            [0, 0, 1, 0],
            [0, 0, 0, 0],
          ],
        ],
        Z: [
          [
            [2, 2, 0, 0],
            [0, 2, 2, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 0, 2, 0],
            [0, 2, 2, 0],
            [0, 2, 0, 0],
            [0, 0, 0, 0],
          ],
        ],
        J: [
          [
            [0, 3, 0, 0],
            [0, 3, 0, 0],
            [3, 3, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [3, 0, 0, 0],
            [3, 3, 3, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 3, 3, 0],
            [0, 3, 0, 0],
            [0, 3, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [3, 3, 3, 0],
            [0, 0, 3, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
        ],
        L: [
          [
            [0, 4, 0, 0],
            [0, 4, 0, 0],
            [0, 4, 4, 0],
            [0, 0, 0, 0],
          ],
          [
            [4, 4, 4, 0],
            [4, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [4, 4, 0, 0],
            [0, 4, 0, 0],
            [0, 4, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 0, 4, 0],
            [4, 4, 4, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
        ],
        I: [
          [
            [0, 5, 0, 0],
            [0, 5, 0, 0],
            [0, 5, 0, 0],
            [0, 5, 0, 0],
          ],
          [
            [5, 5, 5, 5],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
        ],
        O: [
          [
            [0, 6, 6, 0],
            [0, 6, 6, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
        ],
        T: [
          [
            [7, 7, 7, 0],
            [0, 7, 0, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 7, 0, 0],
            [7, 7, 0, 0],
            [0, 7, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 7, 0, 0],
            [7, 7, 7, 0],
            [0, 0, 0, 0],
            [0, 0, 0, 0],
          ],
          [
            [0, 7, 0, 0],
            [0, 7, 7, 0],
            [0, 7, 0, 0],
            [0, 0, 0, 0],
          ],
        ],
      };
      class Map {
        constructor(mapRow, mapCol) {
            this.mapRow=mapRow;
            this.mapCol=mapCol;
          this.mapCode = [
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
            [9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9],
          ];
          this.init();
          this.nextBlock=[];
        }
        init() {
        }
        randerMapCode() {
          for (let i = 0; i < this.mapRow; i++) {
            for (let j = 0; j < this.mapCol; j++) {
              if (this.mapCode[i][j] != 0) {
                this.setColor(i, j, this.mapCode[i][j]);
              }
            }
          }
        }
        setColor(i, j, num) {
          $(".tab1").find("tr")
            .eq(i)
            .children()
            .eq(j)
            .addClass("c" + num);
        }
        setNextColor(){
          for(let i=0;i<4;i++){
            for(let j=0;j<4;j++){
              if(this.nextBlock[i][j]!=0){
                $(".tab2").find("tr").eq(i).children("td").eq(j).addClass("c"+this.nextBlock[i][j])
              }
            }
          }
        }
      }
      class Game {
        constructor(row, col, square, Map) {
          this.row = row;
          this.col = col;
          this.square = square;
          this.Map = new Map(this.row, this.col);
          this.setColor;
          this.init();
        }
        init() {
          this.created();
          this.randerSquare();
          this.Map.randerMapCode();
          this.start();
        }
        start() {
          let self = this;
          this.timer = setInterval(function () {
            self.bindEvent();
              self.clear();
              self.checkdown();
              self.rander();
              self.Map.randerMapCode();
          },200);
        }
        created() {
          let $table1 = $("<table></table>");
          $table1.addClass('tab1');
          for (let i = 0; i < this.row; i++) {
            let $tr = $("<tr></tr>");
            for (let j = 0; j < this.col; j++) {
              let $td = $("<td></td");
              $td.appendTo($tr);
            }
            $tr.appendTo($table1);
          }
          
          let $table2=$("<table></table>")
          $table2.addClass('tab2');
          for(let i=0;i<4;i++){
            let $tr2=$('<tr></tr>');
            for(let j=0;j<4;j++){
              let $td2=$("<td></td>");
              $td2.appendTo($tr2)
            }
            $tr2.appendTo($table2)
          }
          $($table1).appendTo("body");
          $($table2).appendTo("body");
        }
        rander(){
            for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
              if (this.code[i][j] != 0) {
                this.Map.setColor(i+this.blockRow, j+this.blockCol, this.code[i][j]);
              }
            }
          }
        }
        block(){
          this.blockRow=0;
          this.blockCol=4;
          let allType = ["S", "T", "O", "L", "J", "I", "Z"];
          this.type = allType[parseInt(Math.random() * allType.length)];
          this.allDir = this.square[this.type].length;
          this.dir = parseInt(Math.random() * this.allDir);
          return this.square[this.type][this.dir];
        }
        randerSquare() {
          this.blockRow=0;
          this.blockCol=4;
          let allType = ["S", "T", "O", "L", "J", "I", "Z"];
          this.type = allType[parseInt(Math.random() * allType.length)];
          this.allDir = this.square[this.type].length;
          this.dir = parseInt(Math.random() * this.allDir);
          this.code = this.block();
          this.rander();
        }
        randerSmallSquare(){
          this.Map.setNextColor();
          console.log(this.Map.nextBlock);
        }
        check(row,col){
            for(let i=0;i<4;i++){
                for(let j=0;j<4;j++){
                    if(this.code[i][j]!=0&&this.Map.mapCode[i+row][j+col]!=0){
                        return false;
                    }
                }
            }
            return true;
        }
        checkBlockEnd(){
          while(this.check(this.blockRow+1,this.blockCol)){
            this.blockRow++;
          }
        }
        checkdown(){
            if(this.check(this.blockRow+1,this.blockCol)){
                this.blockRow++;
            }else{
                // this.Map.nextBlock=this.block();
                // console.log(this.Map.nextBlock);
                this.randerMap();
                this.randerSquare();
                this.checkRemove();
                this.checkOver();
                this.randerSmallSquare();
            }
        }
        checkLelf(){
          if(this.check(this.blockRow,this.blockCol-1)){
            this.blockCol--;
          }
        }
        checkRight(){
          if(this.check(this.blockRow,this.blockCol+1)){
            this.blockCol++;
          }
        }
        checkRot(){
          let oldDir=this.dir;
          this.dir++;
          if(this.dir>this.allDir-1){
            this.dir=0;
          }
          this.code=this.square[this.type][this.dir];
          if(!this.check(this.blockRow,this.blockCol)){
            this.dir=oldDir;
            this.code=this.square[this.type][this.dir];
          }
        }
        checkRemove(){
          for(let i=0;i<this.row;i++){
              if(this.Map.mapCode[i].indexOf(0)==-1){
                this.Map.mapCode.splice(i,1);
                this.Map.mapCode.unshift([0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]);
              }
          }
        }
        checkOver(){
          for(let i=0;i<this.col;i++){
            if(this.Map.mapCode[0][i]!=0){
              clearInterval(this.timer);
              alert("游戏结束");
            }
          }
        }
        randerMap(){
            for(let i=0;i<4;i++){
                for(let j=0;j<4;j++){
                    if(this.code[i][j]!==0){
                        this.Map.mapCode[this.blockRow+i][this.blockCol+j]=this.code[i][j];
                    }
                }
            }
        }
        clear(){
            for(let i=0;i<this.row;i++){
                for(let j=0;j<this.col;j++){
                    $(".tab1").find("tr").eq(i).children("td").eq(j).removeClass()
                }
            }
            for(let i=0;i<4;i++){
              for(let j=0;j<4;j++){
                $(".tab2").find("tr").eq(i).children("td").eq(j).removeClass();
              }
            }
        }
        bindEvent(){
          let self=this;
          document.onkeydown=function(event){
            if(event.keyCode==39){
              self.checkRight();
            }else if(event.keyCode==37){
              self.checkLelf();
            }else if(event.keyCode==40){
              self.checkBlockEnd();
            }else if(event.keyCode==38){
              self.checkRot();
            }
          }
        }
      }
      new Game(20, 12, square, Map);
    </script>
  </body>
</html>
